apt-get install nginx php5-fpm php5-gd

## anonymized logging
# cat /etc/nginx/conf.d/anon-bouncer.conf 
worker_processes auto;
server {
	listen 80;
	listen [::]:80 ipv6only=on;
	listen 443 ssl;
	server_name _;
	access_log /dev/null;
	error_log /dev/null;
	location / {
		proxy_pass http://unix:/var/run/nginx.sock:/;
		proxy_cache_key "$host$request_uri$cookie_user";
		proxy_set_header Host $http_host;
                proxy_hide_header X-Powered-By;
 	}
	ssl_certificate /etc/nginx/ssl/cert.crt;
	ssl_certificate_key /etc/nginx/ssl/cert.key;
	ssl_prefer_server_ciphers on;
        keepalive_timeout    70;
	ssl_session_timeout 10m;
	ssl_session_cache   shared:SSL:10m;
        add_header Strict-Transport-Security "max-age=31556926;includeSubDomains";
        add_header X-Frame-Options deny;
        add_header X-Content-Security-Policy "allow 'self'; script-src 'self'; img-src *; media-src *; object-src 'none'; frame-src 'none'; xhr-src 'none';";
}

# cat /etc/nginx/sites-available/dokuwiki-farm
server {
        listen 127.0.0.1:80 default_server;
        server_name _;
        root /var/www/dokuwiki/;
        index index.php doku.php;

        location / {
                index doku.php;
                try_files $uri $uri/ @dokuwiki;
        }

        location @dokuwiki {
                rewrite ^/_media/(.*) /lib/exe/fetch.php?media=$1 last;
                rewrite ^/_detail/(.*) /lib/exe/detail.php?media=$1 last;
                rewrite ^/_export/([^/]+)/(.*) /doku.php?do=export_$1&id=$2 last;
                rewrite ^/(.*) /doku.php?id=$1 last;
        }

        location ~ \.php$ {
                try_files $uri =404;
                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                fastcgi_pass unix:/var/run/php5-fpm.sock;
                fastcgi_index index.php;
                include fastcgi_params;
        }

        location ~ /(data|conf|bin|inc)/ {
                deny all;
        }

        location ~ /lib/ {
                expires 30d;
        }

        location ~ /\.ht {
                deny all;
        }
}


## dokuwiki from git
apt-get install git
mkdir /var/www
cd /var/www
git clone git://github.com/splitbrain/dokuwiki.git
cd dokuwiki
git checkout -b stable origin/stable

## dokuwiki farm
## https://www.dokuwiki.org/farms
mkdir /var/www/farm
cp /var/dokuwiki/inc/preload.php.dist /var/dokuwiki/inc/preload.php
# preload.php
if(!defined('DOKU_FARMDIR')) define('DOKU_FARMDIR', '/var/www/farm');
include(fullpath(dirname(__FILE__)).'/farm.php');
cd /var/www/farm
wget https://www.dokuwiki.org/_media/dokuwiki_farm_animal.zip
unzip dokuwiki_farm_animal.zip
cp _animal subdomain.example.ext
chown www-data:www-data -R subdomain.example.ext
# new animal -> cp -a subdomain.example.ext sub2.example.ext

## plugins & templates
cd /var/www/dokuwiki/lib/plugins
git clone https://github.com/splitbrain/dokuwiki-plugin-captcha.git captcha
git clone https://github.com/marklundeberg/dokuwiki-plugin-backup.git backup
git clone https://github.com/lupo49/plugin-cspheader.git cspheader
cd /var/www/dokuwiki/lib/tpl
git clone https://github.com/syn-systems/dokuwiki-template-monobook.git monobook
git clone https://github.com/samfisch/dokuwiki-template-arctic.git arctic
git clone https://github.com/moba/dokuwiki-minimal.git headstrong-minimal

## for public farms
# remove "plugin" plugin (plugin manager)
rm -r /var/www/dokuwiki/lib/plugins/plugin/
# disable some settings for public animals
# /var/www/farm/test.informatick.net/conf/local.protected.php
# php
# /etc/php5/conf.d/hosts.ini
[PATH=/var/www/]
open_basedir = /var/www/
upload_tmp_dir=/var/www/tmp
session.save_path=/var/www/tmp
allow_url_fopen = Off
upload_max_filesize = 1M
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,show_source,chroot,chdir,fsockopen,pfsockopen,socket_create,socket_create_listen,phpinfo
# php5-suhosin ?

# restrict dokuwiki config for public wikis
$conf['savedir'] = DOKU_CONF.'../data';
$conf['updatecheck'] = 0;
$conf['htmlok'] = 0;
$conf['phpok'] = 0;
$conf['basedir'] = '';
$conf['baseurl'] = '';
$conf['dmode'] = 0755;
$conf['fmode'] = 0644;
$conf['allowdebug'] = 0;
$conf['fullpath'] = 0;
$conf['authtype'] = 'plain';
$conf['securecookie'] = 1;
$conf['relnofollow'] = 1;
$conf['indexdelay'] = '60*60*24*5';
$conf['iexssprotect'] = 1;
$conf['im_convert'] = '';
$conf['fetchsize'] = 0;
$conf['compress'] = 1;
$conf['cssdatauri'] = 0;
$conf['broken_iua'] = 0;
$conf['xsendfile'] = 0;
$conf['dnslookups'] = 0;
$conf['proxy']['host'] = '';
$conf['proxy']['port'] = '';
$conf['safemodehack'] = 0;
$conf['mailfrom'] = 'no-reply@domain.example';

## create-wiki -> python

## python uwsgi
## http://lars.la/nginx_uwsgi.html
## http://blog.kramerapps.com/post/22551999777/flask-uwsgi-nginx-ubuntu
apt-get install python uwsgi uwsgi-plugin-python
mkdir -p /var/www/createwiki/static/
cd /var/www/create/
# required fix? debian in openVZ container
ln -s /proc/self/fd /dev/fd

chown -R www-data:www-data /var/www/register-wiki/
virtualenv ./env
source env/bin/activate
pip install flask flask-mail
deactivate

# /etc/nginx/sites-available/createwiki
server {
        listen 127.0.0.1:80;
        server_name createwiki.informatick.net;
        root /var/www/createwiki/static;

        location / {
                try_files $uri @regwiki;
        }

        location @regwiki {
                include uwsgi_params;
                uwsgi_param UWSGI_CHDIR /var/www/createwiki/;
                uwsgi_param UWSGI_PYHOME /var/www/createwiki/env;
                uwsgi_param UWSGI_MODULE createwiki;
                uwsgi_param UWSGI_CALLABLE app;
                uwsgi_pass unix:/tmp/uwsgi-createwiki.sock;
        }

}

# /etc/uwsgi/apps-available/createwiki.ini 
[uwsgi]
plugins = python
gid = www-data
uid = www-data
vhost = true
logdate
socket = /tmp/uwsgi-createwiki.sock
master = true
processes = 1
harakiri = 20
limit-as = 128
memory-report
no-orphans
catch-exceptions

